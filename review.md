# CodeReview
- 2020年4月28日(火)10時30分〜12時
- Reviewer(SG)：株式会社ソニックガーデン 西見さん・川村さん
- Reviewee(DIC)：2020年1月期 松浦さん

## Q&A
0. 自己紹介(DIC)
1. パフォーマンスの改善
- 本番環境のUserインデックス、Postsインデックスなどのページの読み込みが遅い(10秒ほど)ときがあります。どのように読み込み速度を改善するべきでしょうか？(DIC)
  - ①フロント、②ネットワーク、③サーバの３つに場合分け。其々で考えられる要素を検討します。(SG)
    - ①フロント(画面の表示速度)の場合
      - Chrome Developer ConsoleでPerformanceを確認。
      - JSが多いとフロントの可能性。
    - ②ネットワークの場合
      - Chrome Developer ConsoleでNetworkを確認。
      - リクエストに対して何秒かという話。サーバの応答速度、ネットワーク待ちが考えられるなら、サーバのロケーションが遠い、ネットワークが弱い。
    - ③サーバの場合(さらにアセット配信、ビューのレンダリング、DBへのアクセスの３つに場合分け)
      - (1)アセット配信(画像、CSS、JS、ユーザーがアップした画像とか)
        - どこから配信するかでパフォーマンスが変わる。Railsサーバならサーバ負荷の影響を受ける。S3のようなストレージサーバならサーバ負荷の影響を受けない。CDNから配信するのが一番早い。物理的に一番近いのでサーバ負荷の影響を受けない。
        - アメリカなら数百ミリ秒影響する。比べるとレスポンスに差があるのはわかるけど、一般人にはわからない。(やっぱり?)国内にサーバを買った方が早いとなる。
      - (2)ビューのレンダリング
        - 地味に多い。Railsのログ(View/DB)を確認する。
        - NewRelic・Skylightのような計測ツールがある。NewRelicは月額200ドル。
        - NewRelicまで使うといろいろ分析できる。高級ツールなので。処理に何ミリ秒か、サーバか、ブラウザかとかから当たりをつけていく。
        - ただ、NewRelicも1週間程度は見ないとダメ。24時間じゃ足りない。まずは手元で、段々ツールで計測したら良い。
        - 体感を利用して「遅いな」という感情を何とかする(クルクル回るマークとか)。何にもないと遅いなという感じ。
      - (3)DBへのアクセス
        - ①インデックスが活用されているか。クエリをpsqlにコピペして、実行計画を取得する。
        - ②N+1が発生していないか。クエリの回数を減らすことがパフォーマンスチューニングのポイント。
        - クエリの回数分SQLが実行され、通信が行われる。クエリ実行数が多すぎるとコネクションプールを圧迫する。クエリの実行速度と回数を減らすのが両輪。
        - 古典的なDBのパフォーマンスチューニングは検索パターンを洗い出して、ちゃんとインデックスが使われてるか一つずつ見ること。
        - あと、bulletというgemを活用すると分析しやすい。n+1に気づけるので便利。あとは検出できたところから潰していく。
      - いまEC2内にDBあるみたいだけど、RDSを使った方が良い。プロダクションで一番の損失はデータの損失。一番DBをバックアップとか冗長化する。
        - RDSは外付けよりもっと便利。便利すぎる。EC2よりRDS。RDSない時代はEC2。進歩した。
        - インスタンスのサイズアップは大変。一番障害起こる。

2. ユーザー情報(User Model)のバリデーションの設計について
- DB、モデルでemail、password以外の項目にnot null制約やpresenceのバリデーションをかけるとその他の項目を入力せずにemail、passwordを変更する場合にバリデーションエラーが発生してしまうので、今回はDB,モデルでのバリデーションはかけずにビューでのバリデーションをかけました。実務的にはどのように設計するのが良いのでしょうか。(DIC)
  - validation context というRailsで用意されてる機能がある。(SG)
    - contextを指定することで、context毎にバリデーションを切り替えられる。
  - あとはFormオブジェクト。(SG)
    - 登録するフォーム毎にクラスを用意する。フォームごとにオリジナルのバリデーション。クラスごとにバリデーションを切り分けられる。
    - RailsはモデルとDBを一対一で紐付けと考えてしまいがち。
  - Railsは情報があふれすぎてるので取捨選択が難しい。(SG)
    - RubyKaigiとかのスピーカーの情報をチェックするのが良いかも。
    - https://speakerdeck.com/hotatekaoru/fat-modelnidui-chu-suru-6tufalserihuakutaringupatan
  - 余談だけど"concern"はおすすめしない。混ざってしまう。切り分けにくくなってしまう。(SG)
    - ちなみにRubyのモジュールのミックスインとかもオブジェクト指向をしっかり理解した人は敬遠する。
  - テーブルの切り分けについて。(DIC)
    - uniquenessがかからない可能性が存在する。なのでDBの制約が最強。(SG)
    - テーブルの数が増えるのは問題ない。JOINが2つとか3つならOK。言われてるほどJOINは遅くない。(SG)
    - nullが穴だらけの方が後々問題になる。nullがない方が。nullってけっこう辛い。Rubyは言語の性質上、nullと戦う。(SG)
    - ※ users、user_basic_informations、user_xxxx

3. ユーザー情報の編集フォームについて
- 編集ページは1ページに集約する一方で、ユーザーに小分けで情報入力を求めるために下記要件で編集フォームを実装しました。より良い実装の方法はあるでしょうか？(DIC)
  - uses/show.html.erbで自分のアカウントの場合であれば各項目（基礎情報、職歴、学歴）ごとに編集ボタンが表示される
  - 編集ボタンクリックでusers/show.html.erbに埋め込んだ編集用のモーダルが現れる
  - 編集用モーダルはrender partialでformにローカル変数を渡し（例：users/show.html.erb 395行目）、form.html.erbのif文（例：users/form.html.erb 156行目）によってローカル変数ごとに表示されるフォームが変わっている
    - モーダルを作るコントローラーを作る。(SG)
    - JSでモーダルのhtmlを返す。(SG)
    - (例) Users::WorkExperiencesController　＞　GET /users/:user_id/work_experiences/:id/edit　＞　XHRでmodalのHTMLを返す　＞　フロントでHTMLをJSでモーダルとしてレンダリング。
    - (例) PUT or PATCH /users/:user_id/work_experiences/:id　＞　職歴だけ更新できる。
    - Railsのやり方に乗っていた方が遠回りのようでシンプル。(SG)

4. 他受講生から
- 自分でWebアプリを製作したら、簡単そうなこと(例えば動画投稿機能)が面倒で、面倒そうなこと(例えばJSでアニメーション)が意外と簡単でした。お客さん(非エンジニア)と打ち合わせをするときに、同じような行き違いが発生しそうな気がしましたが、エンジニアのリアルというか、説得の仕方みたいなのありましたら、技術的な話じゃないので恐縮ですが、お伺いできたら幸いです。(DIC)
  - 技術はすごい大事。その上で、いま何を作ってるかが大事。(SG)
  - お客さんに代替手段を提案したり。要件の本質を理解するということ。(SG)
  - ある程度は経験しないと。(SG)
- 初めてWebアプリを製作しましたが、もっとレベルアップしたいというときに、次のステップのおすすめを経験ベースで教えていただけたら。個人差あると思いますので、一般論的な話になるかもですけど、アドバイスを頂戴できたら幸いです（やっぱり働くのが一番だとは思いますが）。(DIC)
  - 何をもってレベルアップとするかという話がありますが、確実なのが、手が早くなること。(SG)
  - 1対1対応が早くなる。いろんなものを作る。都度調べて、繰り返して、タマを増やしていく。(SG)
  - 技術要素を絞って、やれることの引き出しを増やす。(SG)
- 今後、就職活動をするにあたり、採用されるかという問題もありますが、正直、できるだけ良い会社、エンジニアを大事にする会社に就職したいです。で、大学生の就活とかも同じですが、就活生に人気のある会社と、転職者に人気のある会社は往々にして食い違いがあるように思います。なので、未経験者がエンジニアとして就職したいというときに、持っておくべき観点みたいなのをお伺いできたら幸いです。(DIC)
  - その会社のエンジニアのCTOと飲めば良い。やっぱり会社の外からの情報じゃわからないことがある。(SG)
  - その過程で知り合いにもなる。会社としては知らない人を雇うのはリスクがあるから。(SG)
  - 実際にスパイしよう。(SG)
  - Rubyはコミュニティにアクセスしやすいから活用。(SG)
- プログラミングスクールを卒業したことを就職活動でどういった形でPR出来ると思いますか？卒業課題をポートフォリオとする、スクールで頑張ったことや苦労したことを伝える、興味のある分野を磨きたいなど意思を表明するなどが求職者側では思いつきますが、企業側から見るとどういったことをPRして欲しいなどあるでしょうか？(DIC)
  - 志望動機とかは面接で伺います。(SG)
  - 単純にコードを見せてほしい。コードを見ない会社は入ったときに苦労する。(SG)
  - コードを見せよう。PRする部分はコード。(SG)
- 最後に、コードの評価をお願いしたい。(DIC)
  - 即戦力かは別にして、書けるという認識。Railsのベーシックなのは理解している。(SG)
  - だいぶモノになってる。引き続き、この調子で。(SG)
  - あと、エンジニアの評価として、修羅場をどれくらい抜けたか、障害を経験した回数が大事。そのときにリーダーシップを発揮したか。(SG)
  - 趣味サイトだとしても本番運用経験があると、より良い。(SG)
